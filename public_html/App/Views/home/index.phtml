<!-- =============================================== -->
<!-- Conteúdo Principal (Main Content) -->
<!-- =============================================== -->
<main class="main-content flex-grow-1 p-4" id="page-home">
    <!-- Header Mobile com botão para abrir o Offcanvas -->
    <div class="d-md-none d-flex justify-content-between align-items-center mb-4 mobile-header">
        <h5 class="logo-title text-dark mb-0">ROSS</h5>
        <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu">
            <i class="bi bi-list fs-3" style="color: var(--primary-dark-blue);"></i>
        </button>
    </div>

    <?php if ($this->view->upload_status == 'success') { ?>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Sucesso!</strong> Seu contrato foi enviado para análise.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php } else if (!empty($this->view->upload_status)) { ?>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro!</strong> Não foi possível enviar seu contrato. Por favor, tente novamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php } ?>

    <div class="container-fluid px-0">
        <!-- Cabeçalho do Dashboard -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="display-6 mb-0">Visão Geral</h2>
                <p class="text-muted mb-0">Análise de Contratos</p>
            </div>
            <button type="button" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#uploadContractModal">
                <i class="bi bi-plus-lg me-2"></i> Nova Análise
            </button>
        </div>

        <!-- Linha de Cards com Estatísticas -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-center h-100">
                    <div class="card-body p-3 d-flex flex-column justify-content-center">
                        <h5 class="card-title text-info-emphasis">Enviados Hoje</h5>
                        <p class="display-5"><?= $this->view->dashboardStats['sent_today'] ?? 0 ?></p>
                        <div class="text-muted"><i class="bi bi-calendar-day me-1"></i>Últimas 24h</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-center h-100">
                    <div class="card-body p-3 d-flex flex-column justify-content-center">
                        <h5 class="card-title text-warning-emphasis">Pendentes</h5>
                        <p class="display-5"><?= $this->view->dashboardStats['pending'] ?? 0 ?></p>
                         <div class="text-muted"><i class="bi bi-clock-history me-1"></i>Aguardando análise</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-center h-100">
                    <div class="card-body p-3 d-flex flex-column justify-content-center">
                        <h5 class="card-title text-success-emphasis">Processados</h5>
                        <p class="display-5"><?= $this->view->dashboardStats['processed'] ?? 0 ?></p>
                         <div class="text-muted"><i class="bi bi-check-circle me-1"></i>Análise concluída</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-center h-100">
                    <div class="card-body p-3 d-flex flex-column justify-content-center">
                        <h5 class="card-title text-danger-emphasis">Com Erro</h5>
                        <p class="display-5"><?= $this->view->dashboardStats['with_error'] ?? 0 ?></p>
                        <div class="text-muted"><i class="bi bi-exclamation-triangle me-1"></i>Requerem atenção</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela de Últimos Contratos -->
        <h3 class="mb-3">Últimas Análises</h3>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome do Contrato</th>
                                <th scope="col">Status</th>
                                <th scope="col">Data de Envio</th>
                                <th scope="col">Tempo de Análise</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($this->view->latestContracts)) { ?>
                                <tr>
                                    <td colspan="4" class="text-center">Nenhum contrato encontrado.</td>
                                </tr>
                            <?php } else { ?>
                                <?php
                                foreach ($this->view->latestContracts as $contract) {
                                    $status = App\Helpers\StatusHelper::formatStatus($contract['status']);
                                    $formatted_date = date('d/m/Y', strtotime($contract['created_at']));
                                        
                                    $analysis_time_html = '';
                                    if (strtolower($contract['status']) === 'processed') {
                                        if ($contract['segundos_para_analisar'] !== null) {
                                            $seconds = (int)$contract['segundos_para_analisar'];
                                            if ($seconds < 1) {
                                                $analysis_time_html = '&lt; 1s';
                                            } else {
                                                $minutes = floor($seconds / 60);
                                                $remainingSeconds = $seconds % 60;
                                                $analysis_time_html = ($minutes > 0 ? "{$minutes}m " : '') . "{$remainingSeconds}s";
                                            }
                                        } else {
                                            // Fallback para status processado sem tempo de análise (caso raro)
                                            $analysis_time_html = '-';
                                        }
                                    } else {
                                        // Se o status não for 'processed', mostra um ícone de relógio
                                        $analysis_time_html = '<i class="bi bi-clock text-muted" title="Aguardando processamento"></i>';
                                    }
                                ?>
                                    <tr>
                                        <td><?= htmlspecialchars(str_replace('.pdf', '', $contract['original_filename'])) ?></td>
                                        <td><span class="badge <?= $status['class'] ?> rounded-pill"><?= htmlspecialchars($status['text']) ?></span></td>
                                        <td><?= $formatted_date ?></td>
                                        <td><?= $analysis_time_html ?></td>
                                    </tr>
                                <?php } ?>
                            <?php } ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</main>

<?php require_once __DIR__ . '/../layouts/partials/upload_modal.phtml'; ?>

