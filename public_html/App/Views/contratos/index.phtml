<!-- =============================================== -->
<!-- Conteúdo Principal (Main Content) -->
<!-- =============================================== -->
<main class="main-content flex-grow-1 p-4" id="page-contratos">
    <!-- Header Mobile com botão para abrir o Offcanvas -->
    <div class="d-md-none d-flex justify-content-between align-items-center mb-4 mobile-header">
        <h5 class="logo-title text-dark mb-0">ROSS</h5>
        <button class="btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu">
            <i class="bi bi-list fs-3" style="color: var(--primary-dark-blue);"></i>
        </button>
    </div>

    <!-- Cabeçalho da Página -->
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-3">
        <div>
            <h2 class="display-6 d-none d-md-block mb-0">Meus Contratos</h2>
            <h2 class="h5 d-block d-md-none mb-0">Meus Contratos</h2>
            <p class="text-muted mb-0">Gerencie e analise seus documentos enviados.</p>
        </div>
        <a href="#" class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#uploadContractModal">
            <i class="bi bi-plus-lg me-2"></i> Nova Análise
        </a>
    </div>

    <!-- Breadcrumb -->
    <div class="mb-4">
        <?php include __DIR__ . '/../layouts/partials/breadcrumb.phtml'; ?>
    </div>

    <?php if ($this->view->upload_status == 'success') { ?>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Sucesso!</strong> Seu contrato foi enviado para análise.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php } else if (!empty($this->view->upload_status)) { ?>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Erro!</strong> Não foi possível enviar seu contrato. Por favor, tente novamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <?php } ?>

    <div class="container-fluid px-0">
        <!-- Filtros de Busca -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Filtros</h5>
                <form action="/contratos" method="GET" class="row g-3 align-items-end">
                    <div class="col-lg-4 col-md-12">
                        <label for="search" class="form-label">Buscar por nome</label>
                        <input type="text" class="form-control" id="search" name="search" placeholder="Digite o nome do contrato..." value="<?= htmlspecialchars($this->view->filters['search'] ?? '') ?>">
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-select">
                            <option value="">Todos</option>
                            <option value="pending" <?= (($this->view->filters['status'] ?? '') == 'pending') ? 'selected' : '' ?>>Pendente</option>
                            <option value="processed" <?= (($this->view->filters['status'] ?? '') == 'processed') ? 'selected' : '' ?>>Processado</option>
                            <option value="error" <?= (($this->view->filters['status'] ?? '') == 'error') ? 'selected' : '' ?>>Com Erro</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="start_date" class="form-label">Data Início</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="<?= htmlspecialchars($this->view->filters['start_date'] ?? '') ?>">
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="end_date" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="<?= htmlspecialchars($this->view->filters['end_date'] ?? '') ?>">
                    </div>
                    <div class="col-lg-2 col-md-6 d-flex">
                        <button type="submit" class="btn btn-primary w-100 me-2">Filtrar</button>
                        <button type="button" id="clear-filters-btn" class="btn btn-outline-secondary w-100">Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de Contratos -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome</th>
                                <th scope="col">Status</th>
                                <th scope="col">Data de Envio</th>
                                <th scope="col">Tempo de Análise</th>
                                <th scope="col" class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($this->view->contracts)) { ?>
                                <tr>
                                    <td colspan="5" class="text-center">Nenhum contrato encontrado.</td>
                                </tr>
                            <?php
                            } else {
                                foreach ($this->view->contracts as $contract) {
                                    $status = App\Helpers\StatusHelper::formatStatus($contract['status']);
                                    $formatted_date = date('d/m/Y H:i', strtotime($contract['created_at']));

                                    $analysis_time_html = '';
                                    if (strtolower($contract['status']) === 'processed') {
                                        if ($contract['segundos_para_analisar'] !== null) {
                                            $seconds = (int)$contract['segundos_para_analisar'];
                                            if ($seconds < 1) {
                                                $analysis_time_html = '&lt; 1s';
                                            } else {
                                                $minutes = floor($seconds / 60);
                                                $remainingSeconds = $seconds % 60;
                                                $analysis_time_html = ($minutes > 0 ? "{$minutes}m " : '') . "{$remainingSeconds}s";
                                            }
                                        } else {
                                            $analysis_time_html = '-';
                                        }
                                    } else {
                                        $analysis_time_html = '<i class="bi bi-clock text-muted" title="Aguardando processamento"></i>';
                                    }
                            ?>
                                    <tr>
                                        <td><?= htmlspecialchars(str_replace('.pdf', '', $contract['original_filename'])) ?></td>
                                        <td><span class="badge <?= $status['class'] ?> rounded-pill"><?= htmlspecialchars($status['text']) ?></span></td>
                                        <td><?= $formatted_date ?></td>
                                        <td class="text-center"><?= $analysis_time_html ?></td>
                                        <td class="table-actions text-end">
                                            <!-- Ações para Desktop -->
                                            <div class="d-none d-md-inline-flex">
                                                <a href="/contrato?contrato_id=<?= htmlspecialchars($contract['id']) ?>" class="btn <?= ($status['text'] === 'Pendente') ? 'disabled' : '' ?> <?= ($status['text'] === 'Erro') ? 'disabled' : '' ?> btn-sm btn-outline-secondary me-1" title="Visualizar"><i class="bi bi-eye"></i></a>
                                                <a href="<?= htmlspecialchars($contract['storage_path']) ?>" target="_blank" class="btn btn-sm btn-outline-primary me-1" title="Download"><i class="bi bi-download"></i></a>
                                                <a href="#" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></a>
                                            </div>
                                            <!-- Dropdown para Mobile -->
                                            <div class="dropdown d-md-none">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                                    <li><a class="dropdown-item" href="/contrato?contrato_id=<?= htmlspecialchars($contract['id']) ?>"><i class="bi bi-eye me-2"></i>Visualizar</a></li>
                                                    <li><a class="dropdown-item" href="<?= htmlspecialchars($contract['storage_path']) ?>" target="_blank"><i class="bi bi-download me-2"></i>Download</a></li>
                                                    <li>
                                                        <hr class="dropdown-divider">
                                                    </li>
                                                    <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i>Excluir</a></li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                            <?php
                                } // Fecha o foreach
                            } // Fecha o else
                            ?>
                        </tbody>
                    </table>
                </div>

                <!-- Navegação da Paginação -->
                <?php if ($this->view->total_pages > 1) { ?>
                    <nav aria-label="Navegação da página de contratos" class="mt-4 d-flex justify-content-end">
                        <ul class="pagination">
                            <li class="page-item <?= ($this->view->current_page <= 1) ? 'disabled' : '' ?>">
                                <a class="page-link" href="?page=<?= $this->view->current_page - 1 ?>&<?= $this->view->filter_query_string ?>" aria-label="Anterior">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            
                            <!-- Opcional: Links de página individuais (pode ser adicionado no futuro se necessário) -->

                            <li class="page-item <?= ($this->view->current_page >= $this->view->total_pages) ? 'disabled' : '' ?>">
                                <a class="page-link" href="?page=<?= $this->view->current_page + 1 ?>&<?= $this->view->filter_query_string ?>" aria-label="Próxima">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                <?php } ?>

            </div>
        </div>
    </div>
</main>

<?php require_once __DIR__ . '/../layouts/partials/upload_modal.phtml'; ?>
